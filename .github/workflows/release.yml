name: Release

on:
  release:
    types: [published]

jobs:
  build-and-deploy:
    name: Build and Deploy Release Artifacts
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: datapainter
          - os: macos-latest
            platform: macos
            artifact: datapainter
          - os: windows-latest
            platform: windows
            artifact: datapainter.exe

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libsqlite3-dev libncurses-dev debhelper devscripts build-essential

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake sqlite3

    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        vcpkg install sqlite3:x64-windows

    - name: Configure CMake
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        else
          cmake -B build -DCMAKE_BUILD_TYPE=Release
        fi
      shell: bash

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          ctest -C Release --output-on-failure
        else
          ctest --output-on-failure
        fi
      shell: bash

    - name: Build Debian package (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Configure git for debuild
        git config --global user.email "gregb@ifost.org.au"
        git config --global user.name "Greg Baker"

        # Build the package
        dpkg-buildpackage -us -uc -b

        # Move .deb to current directory
        mv ../*.deb ./ || true
        ls -la *.deb

    - name: Upload Debian package to release
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter_${{ github.ref_name }}-1_amd64.deb
        asset_name: datapainter_${{ github.ref_name }}-1_amd64.deb
        asset_content_type: application/vnd.debian.binary-package

    - name: Package binary (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir -p release
        cp build/${{ matrix.artifact }} release/
        cp README.md release/
        cp LICENSE release/
        cp docs/datapainter.1 release/
        tar -czf datapainter-${{ matrix.platform }}-${{ github.ref_name }}.tar.gz -C release .

    - name: Package binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir -p release
        cp build/Release/${{ matrix.artifact }} release/
        cp README.md release/
        cp LICENSE release/
        Compress-Archive -Path release/* -DestinationPath datapainter-${{ matrix.platform }}-${{ github.ref_name }}.zip
      shell: pwsh

    - name: Upload release artifacts (Linux/macOS)
      if: matrix.os != 'windows-latest'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter-${{ matrix.platform }}-${{ github.ref_name }}.tar.gz
        asset_name: datapainter-${{ matrix.platform }}-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip

    - name: Upload release artifacts (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter-${{ matrix.platform }}-${{ github.ref_name }}.zip
        asset_name: datapainter-${{ matrix.platform }}-${{ github.ref_name }}.zip
        asset_content_type: application/zip

    # Deploy to packages.industrial-linguistics.com if SSH key is configured
    - name: Generate APT repository metadata (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Import GPG key
        echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import

        # Create repository structure locally
        mkdir -p apt-repo/pool/main apt-repo/dists/stable/main/binary-amd64

        # Copy .deb to pool
        cp datapainter_*.deb apt-repo/pool/main/

        # Generate Packages file
        cd apt-repo
        dpkg-scanpackages --multiversion pool/main > dists/stable/main/binary-amd64/Packages
        gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz

        # Generate Release file
        cd dists/stable
        cat > Release <<EOF
        Origin: Industrial Linguistics
        Label: DataPainter
        Suite: stable
        Codename: stable
        Version: 1.0
        Architectures: amd64
        Components: main
        Description: DataPainter Package Repository
        Date: $(date -Ru)
        EOF

        # Add checksums
        {
            echo "MD5Sum:"
            find main -type f -exec md5sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
            echo "SHA1:"
            find main -type f -exec sha1sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
            echo "SHA256:"
            find main -type f -exec sha256sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
        } >> Release

        # Sign Release file
        gpg --default-key packages@industrial-linguistics.com -abs -o Release.gpg Release
        gpg --default-key packages@industrial-linguistics.com --clearsign -o InRelease Release

        cd ../..

    - name: Deploy to package server (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOYMENT_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

        # Deploy tarball
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          datapainter-${{ matrix.platform }}-${{ github.ref_name }}.tar.gz \
          datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/

        # Deploy entire APT repository
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -r apt-repo/* \
          datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/
      continue-on-error: true
