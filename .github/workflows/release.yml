name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0-test'

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: Build and Deploy Release Artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: datapainter
          - os: macos-latest
            platform: macos
            artifact: datapainter
          - os: windows-latest
            platform: windows
            artifact: datapainter.exe

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libsqlite3-dev libncurses-dev libgtest-dev libgmock-dev googletest debhelper devscripts build-essential

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake sqlite3

    - name: Setup vcpkg (Windows)
      if: matrix.os == 'windows-latest'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'f7423ee180c4b7f40d43402c2feb3859161ef625'  # Latest stable

    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        vcpkg install sqlite3:x64-windows
      shell: bash

    - name: Configure CMake
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -B build -DCMAKE_BUILD_TYPE=Release
        fi
      shell: bash

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          ctest -C Release --output-on-failure
        else
          ctest --output-on-failure
        fi
      shell: bash

    - name: Build Debian package (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Configure git for debuild
        git config --global user.email "gregb@ifost.org.au"
        git config --global user.name "Greg Baker"

        # Build the package
        dpkg-buildpackage -us -uc -b

        # Move .deb to current directory and rename to include version
        mv ../datapainter_*.deb ./ || true
        ls -la *.deb

    - name: Upload Debian package to release
      if: matrix.os == 'ubuntu-latest' && github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter_0.1.0-1_amd64.deb
        asset_name: datapainter_${{ steps.version.outputs.VERSION }}_amd64.deb
        asset_content_type: application/vnd.debian.binary-package

    - name: Package binary (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p release
        cp build/${{ matrix.artifact }} release/
        cp README.md release/
        cp LICENSE release/
        cp docs/datapainter.1 release/
        tar -czf datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.tar.gz -C release .

    - name: Package macOS installer
      if: matrix.os == 'macos-latest'
      run: |
        # Extract version from github.ref_name (remove 'v' prefix if present)
        VERSION="${{ steps.version.outputs.VERSION }}"
        VERSION="${VERSION#v}"

        # Build .pkg installer
        chmod +x scripts/build-macos-pkg.sh
        ./scripts/build-macos-pkg.sh "$VERSION" build/${{ matrix.artifact }} docs/datapainter.1

        # Rename to include platform
        mv "datapainter-${VERSION}.pkg" "datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.pkg"

    - name: Package binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir -p release
        cp build/Release/${{ matrix.artifact }} release/
        cp README.md release/
        cp LICENSE release/
        cp scripts/install.ps1 release/
        cp scripts/uninstall.ps1 release/
        Compress-Archive -Path release/* -DestinationPath datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.zip
      shell: pwsh

    - name: Upload release artifacts (Linux tarball)
      if: matrix.os == 'ubuntu-latest' && github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.tar.gz
        asset_name: datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.tar.gz
        asset_content_type: application/gzip

    - name: Upload release artifacts (macOS .pkg)
      if: matrix.os == 'macos-latest' && github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.pkg
        asset_name: datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.pkg
        asset_content_type: application/octet-stream

    - name: Upload release artifacts (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.zip
        asset_name: datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.zip
        asset_content_type: application/zip

    # Deploy to packages.industrial-linguistics.com if SSH key is configured
    - name: Generate APT repository metadata (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Import GPG key
        echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import

        # Export public key for users to download
        gpg --armor --export packages@industrial-linguistics.com > PUBLIC.KEY

        # Create repository structure locally
        mkdir -p apt-repo/pool/main apt-repo/dists/stable/main/binary-amd64

        # Copy .deb to pool
        cp datapainter_*.deb apt-repo/pool/main/

        # Generate Packages file
        cd apt-repo
        dpkg-scanpackages --multiversion pool/main > dists/stable/main/binary-amd64/Packages
        gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz

        # Generate Release file
        cd dists/stable
        cat > Release <<EOF
        Origin: Industrial Linguistics
        Label: DataPainter
        Suite: stable
        Codename: stable
        Version: 1.0
        Architectures: amd64
        Components: main
        Description: DataPainter Package Repository
        Date: $(date -Ru)
        EOF

        # Add checksums
        {
            echo "MD5Sum:"
            find main -type f -exec md5sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
            echo "SHA1:"
            find main -type f -exec sha1sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
            echo "SHA256:"
            find main -type f -exec sha256sum {} \; | sed 's/\(.*\)  \(.*\)/ \1 $(stat -c%s "\2") \2/'
        } >> Release

        # Sign Release file
        gpg --default-key packages@industrial-linguistics.com -abs -o Release.gpg Release
        gpg --default-key packages@industrial-linguistics.com --clearsign -o InRelease Release

        cd ../..

    - name: Deploy to package server
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOYMENT_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

        # Common SCP options with timeout
        SCP_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=10 -o ServerAliveCountMax=3"

        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          # Deploy Linux tarball
          timeout 120 scp $SCP_OPTS \
            datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.tar.gz \
            datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/

          # Deploy public key
          timeout 120 scp $SCP_OPTS \
            PUBLIC.KEY \
            datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/

          # Deploy entire APT repository
          timeout 180 scp $SCP_OPTS \
            -r apt-repo/* \
            datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/

        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          # Deploy macOS .pkg installer
          timeout 120 scp $SCP_OPTS \
            datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.pkg \
            datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/

        elif [ "${{ matrix.os }}" == "windows-latest" ]; then
          # Deploy Windows ZIP
          timeout 120 scp $SCP_OPTS \
            datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.zip \
            datapainter@merah.cassia.ifost.org.au:/var/www/vhosts/packages.industrial-linguistics.com/htdocs/datapainter/
        fi
      shell: bash
      continue-on-error: true

    # Upload artifacts for manual workflow runs (for testing)
    - name: Upload build artifacts (Linux)
      if: matrix.os == 'ubuntu-latest' && github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: datapainter-linux-${{ steps.version.outputs.VERSION }}
        path: |
          datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.tar.gz
          datapainter_*.deb

    - name: Upload build artifacts (macOS)
      if: matrix.os == 'macos-latest' && github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: datapainter-macos-${{ steps.version.outputs.VERSION }}
        path: datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.pkg

    - name: Upload build artifacts (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: datapainter-windows-${{ steps.version.outputs.VERSION }}
        path: datapainter-${{ matrix.platform }}-${{ steps.version.outputs.VERSION }}.zip
